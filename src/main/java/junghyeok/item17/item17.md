# 변경 가능성을 최소화 하라

클래스를 불변으로 만들려면 다음 다섯가지 규칙을 따라야한다.

+ 객체의 상태를 변경하는 메서드를 제공하지 않는다.
+ 클래스를 확장할 수 없도록 한다.
+ 모든 field를 final로 선언한다.
+ 모든 필드를 private으로 선언한다.
+ 자신 외에는 내부의 가변 컴포넌트에 접근할 수 없도록 한다.

자기 자신클래스의 인스턴스를 반환하는 메서드를 작성할경우, 현재의 인스턴스에서 필드값을 변경해서 반환하지말고 새로운 인스턴스를 생성해 반환해야한다.  
책의 복소수 예제를 참고하자.

## 불변 객체는 근본적으로 스레드 세이프해서 따로 동기화 할 필요가 없다. 그렇기 때문에 안심하고 공유가 가능하다.
그래서 불변 클래스라면 한번만든 인스턴스를 재활용하는것을 권장한다. (상수로 제공하기)   
상수로 만든 인스턴스를, 캐싱해서 정적 팩터리 메서드를 제공하면 메모리 사용량과 가비지 컬렉션 비용이 줄어든다.  

## 불변 객체는 자유롭게 공유할 수 있음은 물론, 불변 객체끼리는 내부 데이터를 공유할 수 있다.

```java
class BigInteger{

    final int signum; //부호
    
    final int[] mag; //크기(절댓값)

    public BigInteger negate() {
        return new BigInteger(this.mag, -this.signum); //크기는 같고 부호만 반대인 새로운 BigInteger를 생성(int형 배열인 mag를 공유한다.)
    }
}
```

## 객체를 만들때 다른 불변 객체들을 구성요소로 사용하면 이점이 많다.
예를들어 Map의 key와 Set의 원소로 쓰기에 적합하다.   
맵이나 집합은 안에 담긴 값이 바뀌면 불변식이 허물어지는데, 불변 객체를 사용하면 그런걱정은 하지 않아도된다.

## 불변 객체는 그 자체로 실패 원자성을 제공한다.
상태가 절대 변하지 않으니 잠깐이라도 불일치 상태에 빠질 가능성이없다.

## 불변클래스의 단점 => 값이 다르면 반드시 독립된 객체로 만들어야한다.
독립된 객체로 만들때, 원하는 객체를 완성하기까지의 단계가많고, 그 중간 단계에서 만들어진 객체들이 모두 버려지는 단점을 보완하기 위해서 다음과 같은 해결방법이 존재한다.
+ 다단계 연산(multistep operation)들을 예측해 기본 연산으로 제공한다.
  + 이렇게 한다면, 각 단계마다 객체를 생성하지 않아도되기 때문이다.
+ 가변 동반클래스를 사용한다. (String, StringBuilder)

## 상속을 허용하지 않는방법
생성자를 private혹은 package-private로 만들고, public 정적 팩터리 메서드를 제공하면된다.

## 아이템 정리
+ getter는 제공하더라도, setter를 무조건 만들지 말 것
+ 불변으로 만들 수 없는 클래스라도 변경할 수 있는 부분을 최소한으로 줄일 것 (변경해야할 필드를 뺀 나머지 모두를 final로 선언하기)
+ 다른 합당한 이유가 없다면 모든 필드는 private final이여야한다.
+ 생성자는 불변식 설정이 모두 완료된, 초기화가 완벽히 끝난 상태의 객체를 생성해야한다.