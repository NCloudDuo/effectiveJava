# 스트림 병렬화는 주의해서 적용하라

### 동시성 프로그래밍을 할때, 안정성과 응답 가능상태를 유지하기 위해 애써야한다.

### 성능향상을 위해서 stream().parallel()을 사용해 병렬 프로그래밍을 한다해도, 성능향상을 보장하지 않는다.
+ 스트림 라이브러리가 파이프라인을 병렬화하는 방법을 찾아내지 못하면 안된다.
  + 데이터 소스가 Stream.iterate거나
  + 중간 연산으로 limit를 쓰면 파이프라인 병렬화로는 성능 개선을 기대할 수 없다.

### 대체로 스트림의 소스가 ArratList, HashMap, HashSet, ConcurrentHashMap의 인스턴스거나 배열, int 범위, long 범위일떼 병렬화의 효과가 가장좋다.
+ 이 자료구조들의 특징은, 데이터를 원하는 크기로 정확하고 손쉽게 나눌 수 있다. 그래서 다수의 스레드들에게 분배하기 좋다.
  + 나누는 작업은 Spliterator가 담당
+ 또한, 참조 지역성 즉, 원소들이 연속된 메모리에 배치되어 있기때문에 좋다.
  + 참조 지역성이 낮으면, 스레드는 데이터가 주메모리에서 캐시 메모리로 전송되어 오기를 기다리면서, 일을 안하고 멍을때린다.
  + 그래서 참조지역성은 다량의 데이터를 처리할때 매우 중요하고, 참조지역성이 제일 뛰어난 자료구조는 배열이다.

### 스트림 파이프라인의 종단 연산의 동작방식이 병렬 수행효율에 영항을 준다.
+ 제일 적합한연산은 reduction이다.
  + min, max, count, sum
  + anyMatch, allMatch, noneMatch

+ 부적합한 연산은 mutable reduction을 수행하는 collect이다.
  + 컬렉션들을 합치는 부담이 크기 때문이다.

### 위와 같은 조건들이 잘 맞춰졌다하더라도, 파이프라인이 수행하는 진짜 작업이 병렬화에 드는 추가비용을 상쇄하지 못한다면 성능향상은 미비할 수 있다.